(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3615],{5723:(e,s,t)=>{Promise.resolve().then(t.bind(t,50844))},50497:(e,s,t)=>{"use strict";var a=t(60685);t.o(a,"usePathname")&&t.d(s,{usePathname:function(){return a.usePathname}}),t.o(a,"useRouter")&&t.d(s,{useRouter:function(){return a.useRouter}}),t.o(a,"useSearchParams")&&t.d(s,{useSearchParams:function(){return a.useSearchParams}})},50844:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>c});var a=t(55155),r=t(21555),l=t(69339),n=t(50497),i=t(84570);function c(){let{user:e,loading:s}=(0,l.A)(),c=(0,n.useRouter)(),o=(0,n.useSearchParams)().get("id"),{ticket:u,loading:m,error:h,refetch:g}=(0,i.yS)(o||""),{updateTicket:x,loading:p}=(0,i.tY)(),{escalateTicket:b,loading:y}=(0,i.oJ)(),{addMessage:f,loading:j}=(0,i.c0)(),[v,N]=(0,r.useState)(""),[k,w]=(0,r.useState)(!1),[S,_]=(0,r.useState)(!1),[E,T]=(0,r.useState)(""),[C,A]=(0,r.useState)(null);(0,r.useEffect)(()=>{s||e?e&&Promise.resolve().then(t.bind(t,15885)).then(({api:e})=>{e.getProfile().then(e=>{A(e);let s=e?.user_role;e&&!["admin","manager","support"].includes(s||"")&&c.push("/dashboard")}).catch(()=>{c.push("/dashboard")})}):c.push("/auth/login")},[e,s,c]);let R=async()=>{if(v.trim()&&o)try{await f({ticketId:o,message:v,isInternal:k}),N(""),w(!1),g()}catch(e){console.error("Failed to send message:",e)}},F=async e=>{if(o)try{await x({ticketId:o,status:e}),g()}catch(e){console.error("Failed to update status:",e)}},I=async()=>{if(C&&o)try{await x({ticketId:o,assigned_to:C.id}),g()}catch(e){console.error("Failed to assign ticket:",e)}},P=async()=>{if(E.trim()&&o)try{await b({ticketId:o,reason:E}),_(!1),T(""),g()}catch(e){console.error("Failed to escalate ticket:",e)}};return o?s||m?(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600",children:"Loading ticket..."})]})}):h||!u?(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("p",{className:"text-red-600",children:"Failed to load ticket"}),(0,a.jsx)("button",{onClick:()=>c.push("/admin/tickets"),className:"mt-4 text-emerald-600 hover:text-emerald-700",children:"Back to Tickets"})]})}):(C?.user_role,(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50 py-8",children:[(0,a.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("button",{onClick:()=>c.push("/admin/tickets"),className:"text-gray-600 hover:text-gray-900 mb-4 flex items-center gap-2",children:"â† Back to Tickets"}),(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:u.title})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,a.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:`px-3 py-1 text-sm font-medium rounded-full ${{open:"bg-blue-100 text-blue-800",in_progress:"bg-yellow-100 text-yellow-800",waiting_response:"bg-purple-100 text-purple-800",escalated:"bg-red-100 text-red-800",resolved:"bg-green-100 text-green-800",closed:"bg-gray-100 text-gray-800"}[u.status]||"bg-gray-100 text-gray-800"}`,children:u.status.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}),(0,a.jsx)("span",{className:`ml-2 px-3 py-1 text-sm font-medium rounded-full ${{low:"bg-gray-100 text-gray-800",medium:"bg-blue-100 text-blue-800",high:"bg-orange-100 text-orange-800",urgent:"bg-red-100 text-red-800"}[u.priority]||"bg-gray-100 text-gray-800"}`,children:u.priority})]}),(0,a.jsxs)("span",{className:"text-sm text-gray-500",children:["Created ",d(u.created_at)]})]}),(0,a.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:u.description})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Messages"}),(0,a.jsx)("div",{className:"space-y-4 mb-6",children:u.messages.map(e=>(0,a.jsxs)("div",{className:`p-4 rounded-lg ${e.is_internal?"bg-yellow-50 border border-yellow-200":e.is_system?"bg-gray-50 border border-gray-200":"bg-blue-50 border border-blue-200"}`,children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"font-semibold text-gray-900",children:e.author?.display_name||"System"}),e.author&&(0,a.jsx)("span",{className:"text-xs px-2 py-1 bg-gray-200 rounded",children:e.author.user_role}),e.is_internal&&(0,a.jsx)("span",{className:"text-xs px-2 py-1 bg-yellow-200 rounded",children:"Internal"})]}),(0,a.jsx)("span",{className:"text-xs text-gray-500",children:d(e.created_at)})]}),(0,a.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:e.message})]},e.id))}),(0,a.jsxs)("div",{className:"border-t pt-4",children:[(0,a.jsx)("textarea",{value:v,onChange:e=>N(e.target.value),placeholder:"Type your message...",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent resize-none",rows:4}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-3",children:[(0,a.jsxs)("label",{className:"flex items-center gap-2",children:[(0,a.jsx)("input",{type:"checkbox",checked:k,onChange:e=>w(e.target.checked),className:"rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"}),(0,a.jsx)("span",{className:"text-sm text-gray-700",children:"Internal note (not visible to user)"})]}),(0,a.jsx)("button",{onClick:R,disabled:j||!v.trim(),className:"px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed",children:j?"Sending...":"Send Message"})]})]})]})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,a.jsx)("h3",{className:"font-semibold mb-4",children:"Actions"}),(0,a.jsxs)("div",{className:"space-y-3",children:[!u.assigned_to&&(0,a.jsx)("button",{onClick:I,disabled:p,className:"w-full px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50",children:"Assign to Me"}),(0,a.jsx)("button",{onClick:()=>_(!0),disabled:y||u.escalation_level>=3,className:"w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50",children:"Escalate Ticket"}),"resolved"!==u.status&&(0,a.jsx)("button",{onClick:()=>F("resolved"),disabled:p,className:"w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50",children:"Mark as Resolved"})]})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,a.jsx)("h3",{className:"font-semibold mb-4",children:"Ticket Information"}),(0,a.jsxs)("div",{className:"space-y-3 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Category:"}),(0,a.jsx)("span",{className:"ml-2 font-medium",children:u.category.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"User:"}),(0,a.jsx)("span",{className:"ml-2 font-medium",children:u.user?.display_name})]}),u.assigned_to&&(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Assigned to:"}),(0,a.jsx)("span",{className:"ml-2 font-medium",children:u.assignee?.display_name})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Escalation Level:"}),(0,a.jsx)("span",{className:"ml-2 font-medium",children:u.escalation_level})]})]})]})]})]})]}),S&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[(0,a.jsx)("h3",{className:"text-xl font-semibold mb-4",children:"Escalate Ticket"}),(0,a.jsx)("textarea",{value:E,onChange:e=>T(e.target.value),placeholder:"Reason for escalation...",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent resize-none",rows:4}),(0,a.jsxs)("div",{className:"flex gap-3 mt-4",children:[(0,a.jsx)("button",{onClick:()=>_(!1),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",children:"Cancel"}),(0,a.jsx)("button",{onClick:P,disabled:!E.trim()||y,className:"flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50",children:y?"Escalating...":"Escalate"})]})]})})]})):(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,a.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Ticket Not Found"}),(0,a.jsx)("p",{className:"mt-2 text-gray-600",children:"No ticket ID provided."}),(0,a.jsx)("button",{onClick:()=>c.push("/admin/tickets"),className:"mt-4 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700",children:"Back to Tickets"})]})})})}function d(e){return new Date(e).toLocaleString()}},69339:(e,s,t)=>{"use strict";t.d(s,{A:()=>l});var a=t(21555),r=t(15885);function l(){let[e,s]=(0,a.useState)(null),[t,l]=(0,a.useState)(!0),[n,i]=(0,a.useState)(!1),[c,d]=(0,a.useState)(null),o=(0,a.useCallback)(async()=>{try{let e=(0,r.getSupabase)(),{data:t,error:a}=await e.auth.refreshSession();if(a)return console.error("[useAuth] Refresh error:",a),!1;if(!t?.session)return console.error("[useAuth] No session returned after refresh"),!1;return d(t.session),s(t.session.user),console.log("[useAuth] Session refreshed successfully"),!0}catch(e){return console.error("[useAuth] Failed to refresh:",e),!1}},[]);return(0,a.useEffect)(()=>{r.api.getUser().then(({data:{user:e}})=>{s(e),l(!1),i(!0)}).catch(()=>{l(!1),i(!0)});let{data:{subscription:e}}=r.api.onAuthStateChange(async(e,t)=>{console.log("[useAuth] Auth state change:",e),"TOKEN_REFRESHED"===e&&console.log("[useAuth] Token refreshed successfully"),d(t),s(t?.user??null),l(!1),i(!0)});return()=>e.unsubscribe()},[]),{user:e,session:c,loading:t,isReady:n,authenticated:!!e,refreshSession:o,signOut:()=>r.api.signOut()}}},84570:(e,s,t)=>{"use strict";t.d(s,{c0:()=>u,Gs:()=>c,oJ:()=>o,yS:()=>i,dS:()=>n,tY:()=>d});var a=t(21555),r=t(15885);function l(e={}){let{onTicketCreated:s,onTicketUpdated:t,onTicketDeleted:n,onMessageAdded:i,ticketId:c}=e;(0,a.useEffect)(()=>{let e=(0,r.getSupabase)(),a=e.channel("support_tickets_changes").on("postgres_changes",{event:"INSERT",schema:"api",table:"support_tickets"},e=>{console.log("Ticket created:",e),s?.(e)}).on("postgres_changes",{event:"UPDATE",schema:"api",table:"support_tickets",...c?{filter:`id=eq.${c}`}:{}},e=>{console.log("Ticket updated:",e),t?.(e)}).on("postgres_changes",{event:"DELETE",schema:"api",table:"support_tickets"},e=>{console.log("Ticket deleted:",e),n?.(e)}).subscribe(),l=null;return c&&i&&(l=e.channel("ticket_messages_changes").on("postgres_changes",{event:"INSERT",schema:"api",table:"ticket_messages",filter:`ticket_id=eq.${c}`},e=>{console.log("Message added:",e),i(e)}).subscribe()),()=>{e.removeChannel(a),l&&e.removeChannel(l)}},[s,t,n,i,c])}function n(e={}){let[s,t]=(0,a.useState)([]),[i,c]=(0,a.useState)(!0),[d,o]=(0,a.useState)(null),[u,m]=(0,a.useState)(0),h=(0,a.useCallback)(async()=>{try{c(!0),o(null);let{tickets:s,total:a}=await r.api.getTickets({status:e.status,category:e.category,assigned_to:e.assigned_to});t(s),m(a)}catch(e){o(e instanceof Error?e.message:"Failed to fetch tickets")}finally{c(!1)}},[e.status,e.category,e.assigned_to]);return(0,a.useEffect)(()=>{if(h(),e.autoRefresh&&e.refreshInterval){let s=setInterval(h,e.refreshInterval);return()=>clearInterval(s)}},[h,e.autoRefresh,e.refreshInterval]),l({onTicketCreated:!1!==e.enableRealtime?()=>h():void 0,onTicketUpdated:!1!==e.enableRealtime?()=>h():void 0,onTicketDeleted:!1!==e.enableRealtime?()=>h():void 0}),{tickets:s,loading:i,error:d,total:u,refetch:h}}function i(e,s=!0){let[t,n]=(0,a.useState)(null),[c,d]=(0,a.useState)(!0),[o,u]=(0,a.useState)(null),m=(0,a.useCallback)(async()=>{if(!e){n(null),d(!1);return}try{d(!0),u(null);let s=await r.api.getTicket(e);n(s)}catch(e){u(e instanceof Error?e.message:"Failed to fetch ticket")}finally{d(!1)}},[e]);return(0,a.useEffect)(()=>{m()},[m]),l({ticketId:e||void 0,onTicketUpdated:s?()=>m():void 0,onMessageAdded:s?()=>m():void 0}),{ticket:t,loading:c,error:o,refetch:m}}function c(){let[e,s]=(0,a.useState)(!1),[t,l]=(0,a.useState)(null);return{createTicket:async e=>{try{return s(!0),l(null),(await r.api.createTicket(e)).ticket}catch(s){let e=s instanceof Error?s.message:"Failed to create ticket";throw l(e),Error(e)}finally{s(!1)}},loading:e,error:t}}function d(){let[e,s]=(0,a.useState)(!1),[t,l]=(0,a.useState)(null);return{updateTicket:async e=>{try{return s(!0),l(null),(await r.api.updateTicket(e)).ticket}catch(s){let e=s instanceof Error?s.message:"Failed to update ticket";throw l(e),Error(e)}finally{s(!1)}},loading:e,error:t}}function o(){let[e,s]=(0,a.useState)(!1),[t,l]=(0,a.useState)(null);return{escalateTicket:async e=>{try{return s(!0),l(null),(await r.api.escalateTicket(e)).ticket}catch(s){let e=s instanceof Error?s.message:"Failed to escalate ticket";throw l(e),Error(e)}finally{s(!1)}},loading:e,error:t}}function u(){let[e,s]=(0,a.useState)(!1),[t,l]=(0,a.useState)(null);return{addMessage:async e=>{try{return s(!0),l(null),(await r.api.addTicketMessage(e)).message}catch(s){let e=s instanceof Error?s.message:"Failed to add message";throw l(e),Error(e)}finally{s(!1)}},loading:e,error:t}}}},e=>{e.O(0,[9731,9631,5885,6939,1170,7358],()=>e(e.s=5723)),_N_E=e.O()}]);