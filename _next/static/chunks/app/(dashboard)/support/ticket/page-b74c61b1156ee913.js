(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2755],{39964:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>c});var a=s(55155),r=s(21555),l=s(69339),n=s(50497),i=s(84570);function c(){let{user:e,loading:t}=(0,l.A)(),s=(0,n.useRouter)(),c=(0,n.useSearchParams)().get("id"),{ticket:d,loading:u,error:m,refetch:h}=(0,i.yS)(c||""),{updateTicket:g,loading:p}=(0,i.tY)(),{addMessage:x,loading:f}=(0,i.c0)(),[b,y]=(0,r.useState)(""),[j,N]=(0,r.useState)(null);(0,r.useEffect)(()=>{t||e||s.push("/auth/login")},[e,t,s]);let v=async()=>{if(b.trim()&&c)try{await x({ticketId:c,message:b}),y(""),h()}catch(e){console.error("Failed to send message:",e)}},k=async e=>{if(c)try{await g({ticketId:c,satisfaction_rating:e}),N(e),h()}catch(e){console.error("Failed to rate ticket:",e)}};return c?t||u?(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600",children:"Loading ticket..."})]})}):m||!d?(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("p",{className:"text-red-600",children:"Failed to load ticket"}),(0,a.jsx)("button",{onClick:()=>s.push("/support"),className:"mt-4 text-emerald-600 hover:text-emerald-700",children:"Back to Support"})]})}):(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,a.jsxs)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:[(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("button",{onClick:()=>s.push("/support"),className:"text-gray-600 hover:text-gray-900 mb-4 flex items-center gap-2",children:"← Back to Support"}),(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:d.title})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("span",{className:`px-4 py-2 text-sm font-medium rounded-full ${{open:"bg-blue-100 text-blue-800",in_progress:"bg-yellow-100 text-yellow-800",waiting_response:"bg-purple-100 text-purple-800",escalated:"bg-red-100 text-red-800",resolved:"bg-green-100 text-green-800",closed:"bg-gray-100 text-gray-800"}[d.status]||"bg-gray-100 text-gray-800"}`,children:d.status.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}),(0,a.jsx)("span",{className:`px-3 py-1 text-sm font-medium rounded-full ${{low:"bg-gray-100 text-gray-800",medium:"bg-blue-100 text-blue-800",high:"bg-orange-100 text-orange-800",urgent:"bg-red-100 text-red-800"}[d.priority]||"bg-gray-100 text-gray-800"}`,children:d.priority})]}),(0,a.jsxs)("span",{className:"text-sm text-gray-500",children:["Created ",o(d.created_at)]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"Original Request:"}),(0,a.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:d.description})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 mt-4 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Category:"}),(0,a.jsx)("span",{className:"ml-2 font-medium",children:d.category.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")})]}),d.assigned_to&&d.assignee&&(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Assigned to:"}),(0,a.jsx)("span",{className:"ml-2 font-medium",children:d.assignee.display_name})]})]})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Conversation"}),(0,a.jsx)("div",{className:"space-y-4 mb-6",children:d.messages.filter(e=>!e.is_internal).map(e=>{let t=e.author&&["support","manager","admin"].includes(e.author.user_role);return(0,a.jsxs)("div",{className:`p-4 rounded-lg ${e.is_system?"bg-gray-50 border border-gray-200":t?"bg-blue-50 border border-blue-200":"bg-emerald-50 border border-emerald-200"}`,children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"font-semibold text-gray-900",children:e.author?.display_name||"System"}),t&&(0,a.jsx)("span",{className:"text-xs px-2 py-1 bg-blue-200 rounded",children:"Support Team"})]}),(0,a.jsx)("span",{className:"text-xs text-gray-500",children:o(e.created_at)})]}),(0,a.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:e.message})]},e.id)})}),"closed"!==d.status&&(0,a.jsxs)("div",{className:"border-t pt-4",children:[(0,a.jsx)("textarea",{value:b,onChange:e=>y(e.target.value),placeholder:"Type your reply...",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent resize-none",rows:4}),(0,a.jsx)("div",{className:"flex justify-end mt-3",children:(0,a.jsx)("button",{onClick:v,disabled:f||!b.trim(),className:"px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed",children:f?"Sending...":"Send Reply"})})]})]}),"resolved"===d.status&&!d.satisfaction_rating&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold mb-4",children:"Rate Your Support Experience"}),(0,a.jsx)("p",{className:"text-gray-600 mb-4",children:"How satisfied are you with the resolution?"}),(0,a.jsx)("div",{className:"flex gap-2",children:[1,2,3,4,5].map(e=>(0,a.jsx)("button",{onClick:()=>k(e),disabled:p,className:"text-4xl hover:scale-110 transition-transform disabled:opacity-50",children:e<=(j||0)?"⭐":"☆"},e))})]}),d.satisfaction_rating&&(0,a.jsxs)("div",{className:"bg-green-50 border border-green-200 rounded-lg p-6",children:[(0,a.jsx)("p",{className:"text-green-800",children:"Thank you for rating this ticket! Your feedback helps us improve."}),(0,a.jsx)("div",{className:"flex gap-1 mt-2",children:[1,2,3,4,5].map(e=>(0,a.jsx)("span",{className:"text-2xl",children:e<=d.satisfaction_rating?"⭐":"☆"},e))})]})]})}):(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,a.jsx)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Ticket Not Found"}),(0,a.jsx)("p",{className:"mt-2 text-gray-600",children:"No ticket ID provided."}),(0,a.jsx)("button",{onClick:()=>s.push("/support"),className:"mt-4 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700",children:"Back to Support"})]})})})}function o(e){return new Date(e).toLocaleString()}},46911:(e,t,s)=>{Promise.resolve().then(s.bind(s,39964))},50497:(e,t,s)=>{"use strict";var a=s(60685);s.o(a,"usePathname")&&s.d(t,{usePathname:function(){return a.usePathname}}),s.o(a,"useRouter")&&s.d(t,{useRouter:function(){return a.useRouter}}),s.o(a,"useSearchParams")&&s.d(t,{useSearchParams:function(){return a.useSearchParams}})},69339:(e,t,s)=>{"use strict";s.d(t,{A:()=>l});var a=s(21555),r=s(15885);function l(){let[e,t]=(0,a.useState)(null),[s,l]=(0,a.useState)(!0),[n,i]=(0,a.useState)(!1),[c,o]=(0,a.useState)(null),d=(0,a.useCallback)(async()=>{try{let e=(0,r.getSupabase)(),{data:s,error:a}=await e.auth.refreshSession();if(a)return console.error("[useAuth] Refresh error:",a),!1;if(!s?.session)return console.error("[useAuth] No session returned after refresh"),!1;return o(s.session),t(s.session.user),console.log("[useAuth] Session refreshed successfully"),!0}catch(e){return console.error("[useAuth] Failed to refresh:",e),!1}},[]);return(0,a.useEffect)(()=>{r.api.getUser().then(({data:{user:e}})=>{t(e),l(!1),i(!0)}).catch(()=>{l(!1),i(!0)});let{data:{subscription:e}}=r.api.onAuthStateChange(async(e,s)=>{console.log("[useAuth] Auth state change:",e),"TOKEN_REFRESHED"===e&&console.log("[useAuth] Token refreshed successfully"),o(s),t(s?.user??null),l(!1),i(!0)});return()=>e.unsubscribe()},[]),{user:e,session:c,loading:s,isReady:n,authenticated:!!e,refreshSession:d,signOut:()=>r.api.signOut()}}},84570:(e,t,s)=>{"use strict";s.d(t,{c0:()=>u,Gs:()=>c,oJ:()=>d,yS:()=>i,dS:()=>n,tY:()=>o});var a=s(21555),r=s(15885);function l(e={}){let{onTicketCreated:t,onTicketUpdated:s,onTicketDeleted:n,onMessageAdded:i,ticketId:c}=e;(0,a.useEffect)(()=>{let e=(0,r.getSupabase)(),a=e.channel("support_tickets_changes").on("postgres_changes",{event:"INSERT",schema:"api",table:"support_tickets"},e=>{console.log("Ticket created:",e),t?.(e)}).on("postgres_changes",{event:"UPDATE",schema:"api",table:"support_tickets",...c?{filter:`id=eq.${c}`}:{}},e=>{console.log("Ticket updated:",e),s?.(e)}).on("postgres_changes",{event:"DELETE",schema:"api",table:"support_tickets"},e=>{console.log("Ticket deleted:",e),n?.(e)}).subscribe(),l=null;return c&&i&&(l=e.channel("ticket_messages_changes").on("postgres_changes",{event:"INSERT",schema:"api",table:"ticket_messages",filter:`ticket_id=eq.${c}`},e=>{console.log("Message added:",e),i(e)}).subscribe()),()=>{e.removeChannel(a),l&&e.removeChannel(l)}},[t,s,n,i,c])}function n(e={}){let[t,s]=(0,a.useState)([]),[i,c]=(0,a.useState)(!0),[o,d]=(0,a.useState)(null),[u,m]=(0,a.useState)(0),h=(0,a.useCallback)(async()=>{try{c(!0),d(null);let{tickets:t,total:a}=await r.api.getTickets({status:e.status,category:e.category,assigned_to:e.assigned_to});s(t),m(a)}catch(e){d(e instanceof Error?e.message:"Failed to fetch tickets")}finally{c(!1)}},[e.status,e.category,e.assigned_to]);return(0,a.useEffect)(()=>{if(h(),e.autoRefresh&&e.refreshInterval){let t=setInterval(h,e.refreshInterval);return()=>clearInterval(t)}},[h,e.autoRefresh,e.refreshInterval]),l({onTicketCreated:!1!==e.enableRealtime?()=>h():void 0,onTicketUpdated:!1!==e.enableRealtime?()=>h():void 0,onTicketDeleted:!1!==e.enableRealtime?()=>h():void 0}),{tickets:t,loading:i,error:o,total:u,refetch:h}}function i(e,t=!0){let[s,n]=(0,a.useState)(null),[c,o]=(0,a.useState)(!0),[d,u]=(0,a.useState)(null),m=(0,a.useCallback)(async()=>{if(!e){n(null),o(!1);return}try{o(!0),u(null);let t=await r.api.getTicket(e);n(t)}catch(e){u(e instanceof Error?e.message:"Failed to fetch ticket")}finally{o(!1)}},[e]);return(0,a.useEffect)(()=>{m()},[m]),l({ticketId:e||void 0,onTicketUpdated:t?()=>m():void 0,onMessageAdded:t?()=>m():void 0}),{ticket:s,loading:c,error:d,refetch:m}}function c(){let[e,t]=(0,a.useState)(!1),[s,l]=(0,a.useState)(null);return{createTicket:async e=>{try{return t(!0),l(null),(await r.api.createTicket(e)).ticket}catch(t){let e=t instanceof Error?t.message:"Failed to create ticket";throw l(e),Error(e)}finally{t(!1)}},loading:e,error:s}}function o(){let[e,t]=(0,a.useState)(!1),[s,l]=(0,a.useState)(null);return{updateTicket:async e=>{try{return t(!0),l(null),(await r.api.updateTicket(e)).ticket}catch(t){let e=t instanceof Error?t.message:"Failed to update ticket";throw l(e),Error(e)}finally{t(!1)}},loading:e,error:s}}function d(){let[e,t]=(0,a.useState)(!1),[s,l]=(0,a.useState)(null);return{escalateTicket:async e=>{try{return t(!0),l(null),(await r.api.escalateTicket(e)).ticket}catch(t){let e=t instanceof Error?t.message:"Failed to escalate ticket";throw l(e),Error(e)}finally{t(!1)}},loading:e,error:s}}function u(){let[e,t]=(0,a.useState)(!1),[s,l]=(0,a.useState)(null);return{addMessage:async e=>{try{return t(!0),l(null),(await r.api.addTicketMessage(e)).message}catch(t){let e=t instanceof Error?t.message:"Failed to add message";throw l(e),Error(e)}finally{t(!1)}},loading:e,error:s}}}},e=>{e.O(0,[9731,9631,5885,6939,1170,7358],()=>e(e.s=46911)),_N_E=e.O()}]);